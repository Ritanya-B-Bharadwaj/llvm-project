{
    "number": 138499,
    "title": "[OpenMP] Fix KMP_OS_AIX handling",
    "body": "When building `openmp` on Linux/sparc64, I get\r\n\r\n```\r\nIn file included fromopenmp/runtime/src/kmp_utility.cpp:16:\r\nopenmp/runtime/src/kmp_wrapper_getpid.h:47:2: warning: No gettid found, use getpid instead [-W#warnings]\r\n   47 | #warning No gettid found, use getpid instead\r\n      |  ^\r\n```\r\n\r\nThis is highly confusing since `<sys/syscall.h>` **does** define `SYS_gettid` and the header is supposed to be included:\r\n\r\n```\r\n#if !defined(KMP_OS_AIX) && !defined(KMP_OS_HAIKU)\r\n#include <sys/syscall.h>\r\n#endif\r\n```\r\n\r\nHowever, this actually is **not** the case for two reasons:\r\n\r\n- `KMP_OS_HAIKU` is always defined, either as 1 on Haiku or as 0 otherwise.\r\n- `KMP_OS_AIX` is even worse: it is only defined as 1 on on AIX, but undefined otherwise.\r\n\r\nAll those `KMP_OS_*` macros are supposed to always be defined as 1/0 as appropriate, and to be checked with `#if`, not `#ifdef`.  AIX is violating this, causing the problem above.\r\n\r\nOther targets probably get `<sys/syscall.h>` indirectly otherwise, but Linux/sparc64 does not.\r\n\r\nThis patch fixes this by also defining `KMP_OS_AIX` as 0 on other OSes and changing the checks to `#if` as necessary.\r\n\r\nTested on `sparc64-unknown-linux-gnu`, `sparcv9-sun-solaris2.11`, `amd64-pc-solaris2.11`, and `x86_64-pc-linux-gnu`.",
    "created_at": "2025-05-05T09:52:19Z",
    "merged_at": "2025-05-05T18:57:41Z",
    "user": "rorth",
    "files": [
        "openmp/runtime/src/kmp.h",
        "openmp/runtime/src/kmp_affinity.cpp",
        "openmp/runtime/src/kmp_platform.h",
        "openmp/runtime/src/kmp_wrapper_getpid.h"
    ],
    "commits": [
        "[OpenMP] Fix KMP_OS_AIX handling\n\nWhen building `openmp` on Linux/sparc64, I get\n\n```\nIn file included fromopenmp/runtime/src/kmp_utility.cpp:16:\nopenmp/runtime/src/kmp_wrapper_getpid.h:47:2: warning: No gettid found, use getpid instead [-W#warnings]\n   47 | #warning No gettid found, use getpid instead\n      |  ^\n```\n\nThis is highly confusing since `<sys/syscall.h>` **does** define\n`SYS_gettid` and the header is supposed to be included:\n\n```\n#if !defined(KMP_OS_AIX) && !defined(KMP_OS_HAIKU)\n#include <sys/syscall.h>\n#endif\n```\n\nHowever, this actually is **not** the case for two reasons:\n\n- `KMP_OS_HAIKU` is always defined, either as 1 on Haiku or as 0 otherwise.\n- `KMP_OS_AIX` is even worse: it is only defined as 1 on on AIX, but\n  undefined otherwise.\n\nAll those `KMP_OS_*` macros are supposed to always be defined as 1/0 as\nappropriate, and to be checked with `#if`, not `#ifdef`.  AIX is violating\nthis, causing the problem above.\n\nOther targets probably get `<sys/syscall.h>` indirectly otherwise, but\nLinux/sparc64 does not.\n\nThis patch fixes this by also defining `KMP_OS_AIX` as 0 on other OSes and\nchanging the checks to `#if` as necessary.\n\nTested on `sparc64-unknown-linux-gnu`, `sparcv9-sun-solaris2.11`,\n`amd64-pc-solaris2.11`, and `x86_64-pc-linux-gnu`."
    ]
}